{% extends "base.html" %}

{% block title %}History - Kisan Dhristi{% endblock %}

{% block content %}
<!-- History Section -->
<section id="history" class="section">
    <div class="section-header">
        <h2>Diagnosis History</h2>
        <p>Track your crop health journey and past consultations</p>
    </div>

    {% if history and history|length > 0 %}
        <!-- History Stats -->
        <div class="history-stats">
            <div class="stat-card">
                <div class="stat-number">{{ history|length }}</div>
                <div class="stat-label">Total Diagnoses</div>
            </div>
        </div>
        
        <!-- History Grid -->
        <div class="history-grid">
            {% for row in history %}
            <div class="history-card">
                <div class="history-header">
                    <!-- ‚úÖ FIXED: Handle string timestamp -->
                    <div class="history-date">
                        {{ row[5][:10]|replace('-', '/') if row[5] else 'Unknown' }}<br>
                        <span style="font-size: 0.8rem;">{{ row[5][11:16] if row[5] else '00:00' }}</span>
                    </div>
                    
                    {% if row[2] and row[2].strip() %}
                    <div class="history-query" title="{{ row[2] }}">
                        {{ row[2][:40] }}{% if row[2]|length > 40 %}...{% endif %}
                    </div>
                    {% endif %}
                </div>
                
                <div class="history-image">
                    {% if row[4] %}
                    <img src="{{ url_for('static', filename=row[4]) }}" 
                         alt="Diagnosis Image" 
                         class="history-img"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div class="image-placeholder" style="display: none;">üñºÔ∏è Image</div>
                    {% endif %}
                </div>
                
                <div class="history-diagnosis">
                    <h4>Diagnosis:</h4>
                    <p>{{ row[3][:150] }}{% if row[3]|length > 150 %}...{% endif %}</p>
                </div>
                
                <div class="history-filename">
                    üìÅ {{ row[1] }}
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- Empty State -->
        <div class="empty-state">
            <svg width="80" height="80" fill="none" stroke="var(--primary)" viewBox="0 0 24 24" style="margin: 0 auto 30px;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <h3 style="font-family: 'Space Grotesk', sans-serif; font-size: 2rem; margin-bottom: 20px;">No History Yet</h3>
            <p style="color: var(--text-secondary); margin-bottom: 30px;">Start diagnosing crops to see your history here</p>
            <a href="{{ url_for('kisan_bot') }}" class="btn btn-primary">Start First Diagnosis</a>
        </div>
    {% endif %}
</section>
{% endblock %}